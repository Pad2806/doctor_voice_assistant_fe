'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Card from '@/components/ui/Card';
import Badge from '@/components/ui/Badge';
import Button from '@/components/ui/Button';
import PatientSearchModal from '@/components/PatientSearchModal';
import PatientFormModal from '@/components/PatientFormModal';
import { Search, UserPlus, TrendingUp, Users, Calendar, Activity, Stethoscope, Trash2 } from 'lucide-react';

interface DashboardStats {
    today: {
        totalSessions: number;
        completedSessions: number;
        activeSessions: number;
    };
    thisWeek: {
        totalSessions: number;
        newPatients: number;
    };
    thisMonth: {
        totalSessions: number;
        newPatients: number;
    };
    total: {
        patients: number;
        sessions: number;
    };
}

interface PatientSummary {
    id: string;
    displayId: string;
    name: string;
    age: number | null;
    gender: string;
    totalVisits: number;
    lastVisitDate: string;
    lastVisitStatus: string;
    lastVisitId: string;
}

export default function DashboardPage() {
    const router = useRouter();
    const [stats, setStats] = useState<DashboardStats | null>(null);
    const [patients, setPatients] = useState<PatientSummary[]>([]);
    const [loading, setLoading] = useState(true);
    const [showPatientSearch, setShowPatientSearch] = useState(false);
    const [showPatientForm, setShowPatientForm] = useState(false);
    const [deletingPatientId, setDeletingPatientId] = useState<string | null>(null);

    useEffect(() => {
        fetchDashboardData();

        // Keyboard shortcut: Ctrl+K to open search
        const handleKeyDown = (e: KeyboardEvent) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                setShowPatientSearch(true);
            }
        };

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, []);

    const fetchDashboardData = async () => {
        try {
            const res = await fetch('/api/dashboard/stats?limit=50');
            const data = await res.json();

            if (data.success) {
                setStats(data.stats);
                setPatients(data.patients);
            }
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleNewPatient = () => {
        setShowPatientForm(true);
    };

    const handleSearch = () => {
        setShowPatientSearch(true);
    };

    const handlePatientCreated = (patientId: string) => {
        setShowPatientForm(false);
        // Refresh dashboard data
        fetchDashboardData();
        // Navigate to examination page
        router.push(`/examination?patientId=${patientId}`);
    };

    const handlePatientSelected = (patientId: string, displayId: string) => {
        setShowPatientSearch(false);
        // Navigate to patient history
        router.push(`/patient/${displayId}/history`);
    };

    const handleQuickExam = (patientId: string, e: React.MouseEvent) => {
        e.stopPropagation(); // Prevent row click
        router.push(`/examination?patientId=${patientId}`);
    };

    const handleDeletePatient = async (patientId: string, displayId: string, e: React.MouseEvent) => {
        e.stopPropagation();

        if (!confirm(`X√≥a to√†n b·ªô h·ªì s∆° b·ªánh nh√¢n ${displayId}? ƒêi·ªÅu n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn t·∫•t c·∫£ phi√™n kh√°m v√† b·ªánh √°n.`)) {
            return;
        }

        setDeletingPatientId(patientId);

        try {
            const res = await fetch(`/api/patient/${patientId}`, {
                method: 'DELETE'
            });

            const data = await res.json();

            if (data.success) {
                fetchDashboardData();
                alert('X√≥a h·ªì s∆° b·ªánh nh√¢n th√†nh c√¥ng!');
            } else {
                alert('L·ªói: ' + data.message);
            }
        } catch (error) {
            console.error('Error deleting patient:', error);
            alert('L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.');
        } finally {
            setDeletingPatientId(null);
        }
    };

    const handleRowClick = (displayId: string) => {
        router.push(`/patient/${displayId}/history`);
    };

    if (loading) {
        return (
            <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-sky-50/30 to-teal-50/30 flex items-center justify-center\">
                < div className =\"text-center\">
                    < div className =\"animate-spin rounded-full h-12 w-12 border-b-2 border-sky-600 mx-auto mb-4\"></div>
                        < p className =\"text-slate-600\">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div >
            </div >
        );
    }

    return (
        <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-sky-50/30 to-teal-50/30 p-6\">
            < div className =\"max-w-7xl mx-auto space-y-6\">
    {/* Header */ }
    <div className=\"flex items-center justify-between\">
        < div >
        <h1 className=\"text-3xl font-bold text-slate-900\">Dashboard</h1>
            < p className =\"text-slate-600 mt-1\">T·ªïng quan h·ªá th·ªëng qu·∫£n l√Ω kh√°m b·ªánh</p>
                    </div >
        <div className=\"flex gap-3\">
            < Button
    variant =\"secondary\"
    onClick = { handleSearch }
    className =\"flex items-center gap-2\"
        >
        <Search className=\"w-5 h-5\" />
                            T√¨m ki·∫øm b·ªánh nh√¢n
        < span className =\"ml-2 text-xs bg-white/50 px-2 py-1 rounded font-mono\">
    Ctrl + K
                            </span >
                        </Button >
        <Button
            variant=\"primary\"
    onClick = { handleNewPatient }
    className =\"flex items-center gap-2\"
        >
        <UserPlus className=\"w-5 h-5\" />
                            B·ªánh nh√¢n m·ªõi
                        </Button >
                    </div >
                </div >

        {/* Stats Grid */ }
    {
        stats && (
            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">
                < StatCard
        icon = {< Activity className =\"w-8 h-8 text-sky-600\" />}
        label =\"H√¥m nay\"
        value = { stats.today.totalSessions }
        subtext = {`${stats.today.completedSessions} ho√†n th√†nh`
    }
    color =\"sky\"
        />
        <StatCard
            icon={<Calendar className=\"w-8 h-8 text-teal-600\" />}
    label =\"Tu·∫ßn n√†y\"
    value = { stats.thisWeek.totalSessions }
    subtext = {`${stats.thisWeek.newPatients} BN m·ªõi`
}
color =\"teal\"
    />
    <StatCard
        icon={<TrendingUp className=\"w-8 h-8 text-emerald-600\" />}
label =\"Th√°ng n√†y\"
value = { stats.thisMonth.totalSessions }
subtext = {`${stats.thisMonth.newPatients} BN m·ªõi`}
color =\"emerald\"
    />
    <StatCard
        icon={<Users className=\"w-8 h-8 text-indigo-600\" />}
label =\"T·ªïng b·ªánh nh√¢n\"
value = { stats.total.patients }
subtext = {`${stats.total.sessions} l·∫ßn kh√°m`}
color =\"indigo\"
    />
                    </div >
                )}

{/* Patients List */ }
<Card variant=\"elevated\" padding=\"none\" className=\"animate-fade-in\">
    < div className =\"p-5 bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200\">
        < h3 className =\"font-bold text-slate-800 text-lg flex items-center gap-2\">
                            üë• Danh s√°ch b·ªánh nh√¢n
                        </h3 >
    <p className=\"text-sm text-slate-600 mt-1\">Click v√†o b·ªánh nh√¢n ƒë·ªÉ xem l·ªãch s·ª≠ kh√°m</p>
                    </div >
    <div className=\"overflow-x-auto\">
{
    patients.length === 0 ? (
        <div className=\"text-center py-12\">
            < div className =\"text-6xl mb-4 opacity-40\">üë§</div>
                < p className =\"text-slate-400 font-medium\">Ch∆∞a c√≥ b·ªánh nh√¢n n√†o</p>
                            </div >
                        ) : (
        <table className=\"w-full\">
            < thead className =\"bg-slate-100 border-b border-slate-200\">
                < tr >
                <th className=\"px-6 py-3 text-left text-sm font-semibold text-slate-700\">M√£ BN</th>
                    < th className =\"px-6 py-3 text-left text-sm font-semibold text-slate-700\">T√™n b·ªánh nh√¢n</th>
                        < th className =\"px-6 py-3 text-left text-sm font-semibold text-slate-700\">Tu·ªïi/Gi·ªõi t√≠nh</th>
                            < th className =\"px-6 py-3 text-left text-sm font-semibold text-slate-700\">S·ªë l·∫ßn kh√°m</th>
                                < th className =\"px-6 py-3 text-left text-sm font-semibold text-slate-700\">Kh√°m g·∫ßn nh·∫•t</th>
                                    < th className =\"px-6 py-3 text-left text-sm font-semibold text-slate-700\">Tr·∫°ng th√°i</th>
                                        < th className =\"px-6 py-3 text-center text-sm font-semibold text-slate-700\">Thao t√°c</th>
                                    </tr >
                                </thead >
        <tbody>
            {patients.map((patient, idx) => (
                <tr
                    key={patient.id}
                    className=\"border-b border-slate-100 hover:bg-sky-50/50 transition cursor-pointer\"
            onClick={() => handleRowClick(patient.displayId)}
            style={{ animationDelay: `${idx * 50}ms` }}
                                        >
            <td className=\"px-6 py-4\">
            <span className=\"font-mono text-sm font-bold text-sky-600\">
            {patient.displayId}
        </span>
                                            </td >
        <td className=\"px-6 py-4\">
            < div className =\"font-medium text-slate-800\">{patient.name}</div>
                                            </td >
        <td className=\"px-6 py-4 text-slate-600\">
    { patient.age ? `${patient.age} tu·ªïi` : 'N/A' } / {patient.gender}
                                            </td >
        <td className=\"px-6 py-4 text-slate-600\">
            < span className =\"font-semibold\">{patient.totalVisits}</span> l·∫ßn
                                            </td >
        <td className=\"px-6 py-4 text-sm text-slate-500\">
    { new Date(patient.lastVisitDate).toLocaleDateString('vi-VN') }
                                            </td >
        <td className=\"px-6 py-4\">
            < StatusBadge status = { patient.lastVisitStatus } />
                                            </td >
        <td className=\"px-6 py-4\">
            < div className =\"flex items-center gap-2 justify-center\">
                < Button
    variant =\"primary\"
    onClick = {(e) => handleQuickExam(patient.id, e)
}
className =\"px-3 py-2 text-xs flex items-center gap-1\"
title =\"T√°i kh√°m/Kh√°m m·ªõi\"
    >
    <Stethoscope className=\"w-4 h-4\" />
Kh√°m
                                                    </Button >
    <Button
        variant=\"danger\"
onClick = {(e) => handleDeletePatient(patient.id, patient.displayId, e)}
className =\"px-3 py-2 text-xs flex items-center gap-1\"
disabled = { deletingPatientId === patient.id}
title =\"X√≥a b·ªánh nh√¢n\"
    >
    { deletingPatientId === patient.id ? (
    <span className=\"animate-spin\">‚è≥</span>
                                                        ) : (
    <Trash2 className=\"w-4 h-4\" />
                                                        )}
X√≥a
                                                    </Button >
                                                </div >
                                            </td >
                                        </tr >
                                    ))}
                                </tbody >
                            </table >
                        )}
                    </div >
                </Card >
            </div >

    {/* Modals */ }
{
    showPatientSearch && (
        <PatientSearchModal
            onClose={() => setShowPatientSearch(false)}
            onPatientSelect={handlePatientSelected}
        />
    )
}

{
    showPatientForm && (
        <PatientFormModal
            onClose={() => setShowPatientForm(false)}
            onPatientCreated={handlePatientCreated}
        />
    )
}
        </div >
    );
}

// StatCard Component
function StatCard({
    icon,
    label,
    value,
    subtext,
    color
}: {
    icon: React.ReactNode;
    label: string;
    value: number;
    subtext: string;
    color: string;
}) {
    const colorClasses = {
        sky: 'from-sky-50 to-sky-100 border-sky-200',
        teal: 'from-teal-50 to-teal-100 border-teal-200',
        emerald: 'from-emerald-50 to-emerald-100 border-emerald-200',
        indigo: 'from-indigo-50 to-indigo-100 border-indigo-200',
    };

    return (
        <Card
            variant=\"elevated\"
    className = {`bg-gradient-to-br ${colorClasses[color as keyof typeof colorClasses]} border`
}
        >
    <div className=\"flex items-start gap-4\">
        < div className =\"p-3 bg-white rounded-xl shadow-sm\">
{ icon }
                </div >
    <div className=\"flex-1\">
        < p className =\"text-sm text-slate-600 font-medium\">{label}</p>
            < p className =\"text-3xl font-bold text-slate-900 mt-1\">{value}</p>
                < p className =\"text-xs text-slate-500 mt-1\">{subtext}</p>
                </div >
            </div >
        </Card >
    );
}

// StatusBadge Component
function StatusBadge({ status }: { status: string }) {
    const statusConfig = {
        'completed': { label: 'Ho√†n th√†nh', variant: 'success' },
        'active': { label: 'ƒêang kh√°m', variant: 'warning' },
        'draft': { label: 'Nh√°p', variant: 'default' },
        'never_visited': { label: 'Ch∆∞a kh√°m', variant: 'default' },
    };

    const config = statusConfig[status as keyof typeof statusConfig] || { label: status, variant: 'default' };

    return <Badge variant={config.variant as any}>{config.label}</Badge>;
}
