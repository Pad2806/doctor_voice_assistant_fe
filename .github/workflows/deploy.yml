name: Deploy Frontend to Dokploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  DOKPLOY_WEBHOOK_URL: ${{ secrets.DOKPLOY_WEBHOOK_URL }}

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint --if-present
        continue-on-error: true

      - name: Build application
        run: npm run build
        env:
          # Build-time environment variables
          # These will be replaced by Dokploy environment variables in production
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:4000' }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || '' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || '' }}

  deploy:
    name: Deploy to Dokploy
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Trigger Dokploy Deployment
        run: |
          if [ -z "$DOKPLOY_WEBHOOK_URL" ]; then
            echo "âŒ DOKPLOY_WEBHOOK_URL secret is not set!"
            echo "Please add DOKPLOY_WEBHOOK_URL to your repository secrets."
            exit 1
          fi
          
          echo "ðŸš€ Triggering Dokploy deployment..."
          
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$DOKPLOY_WEBHOOK_URL")
          
          if [ "$response" -eq 200 ] || [ "$response" -eq 201 ] || [ "$response" -eq 204 ]; then
            echo "âœ… Deployment triggered successfully! (HTTP $response)"
          else
            echo "âŒ Deployment failed with HTTP status: $response"
            exit 1
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | âœ… Triggered |" >> $GITHUB_STEP_SUMMARY
